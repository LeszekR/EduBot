<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
		<title>Koło fortuny</title>
		<script src="fortuneWheelConf.js"></script>
		<script>
			let add;
            let speed;
            let time;

			function letItRole() {
				document.getElementById('spinButton').disabled = true;
				add = 1;
				let interval = 1000;
                let secondsPassed = (new Date().getTime() - time) / 1000;
				let delay = 0;

				var wheelSpinning = setInterval(() => {
					let prevSpeed = speed;
					speed = adjustSpeed(speed);

					secondsPassed += interval / 1000;
					let currentTimeFactor = (secondsPassed + delay) / prevSpeed;
					delay = currentTimeFactor * speed - secondsPassed;

					slowDownTheWheel(speed, delay);
					if (speed > 60) {
						let result = 360 - ((secondsPassed + delay) / speed * 100 % 100 * 3.6);
						let drawn = wheelConfig
							.filter(obj => obj.from < result && obj.to >= result)
							.shift();
						clearInterval(wheelSpinning);
						document.getElementById('fortuneWheel').style.webkitAnimationPlayState = 'paused';
                        document.getElementById('spinButton').disabled = false;
						setTimeout(() => {
						    alert('rezultat: ' + drawn.name);
                        	document.getElementById('fortuneWheel').style = {};
						}, 200);
					}
				}, interval);
			}
			
			function spin() {
                speed = (Math.random() * 3);
			    time = (new Date()).getTime();
				let fortuneWheelStyles = document.getElementById('fortuneWheel').style;
				fortuneWheelStyles.position = 'fixed';
				fortuneWheelStyles.webkitAnimationDuration = speed + 's';
				fortuneWheelStyles.webkitAnimationTimingFunction = 'linear';
				fortuneWheelStyles.webkitAnimationIterationCount = 'infinite';
				fortuneWheelStyles.webkitAnimationName = 'spinnerRotate';
			}
			
			function slowDownTheWheel(speed, delay) {
				let fortuneWheelStyles = document.getElementById('fortuneWheel').style;
				fortuneWheelStyles.webkitAnimationDuration = speed + 's';
				fortuneWheelStyles.webkitAnimationDelay = '-' + delay + 's';
			}
			
			function adjustSpeed(speed) {
				speed += add;
				add++;
				return speed;
			}
		</script>
		<style>
			@-webkit-keyframes spinnerRotate
			{
				from{-webkit-transform:rotate(0deg);}
				to{-webkit-transform:rotate(360deg);}
			}
			@-moz-keyframes spinnerRotate
			{
				from{-moz-transform:rotate(0deg);}
				to{-moz-transform:rotate(360deg);}
			}
			@-ms-keyframes spinnerRotate
			{
				from{-ms-transform:rotate(0deg);}
				to{-ms-transform:rotate(360deg);}
			}
		</style>
	</head>
	<body>
		<button id="spinButton" onmousedown="spin();" onmouseup="letItRole();">Krec</button> <= przytrzymaj jak długo chcesz. Gdy puścisz koło zacznie zwalniać
		<div style="width: 400px;text-align: center;color:red;">\/</div>
		<div id="fortuneWheel">
			<img src="fortuneWheel.png" height="400px;"/>
		</div>
	</body>
</html>
